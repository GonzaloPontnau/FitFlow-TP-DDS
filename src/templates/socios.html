{% extends "base.html" %}

{% block title %}Socios - FitFlow{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Gestión de Socios</h2>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="openModal('modalImportCSV')">
                Importar CSV
            </button>
            <button class="btn btn-primary" onclick="openModal('modalNuevoSocio')">
                + Nuevo Socio
            </button>
        </div>
    </div>

    <div id="socios-list">
        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando socios...</p>
        </div>
    </div>
</div>

<!-- Modal Importar CSV -->
<div id="modalImportCSV" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Importar Socios desde CSV</h3>
            <button class="modal-close" onclick="closeModal('modalImportCSV')">&times;</button>
        </div>
        <form id="formImportCSV" onsubmit="importarCSV(event)">
            <div class="form-group">
                <label>Archivo CSV *</label>
                <input type="file" name="archivo" accept=".csv" required>
                <small>Formato: Nombre, Apellido, DNI, Email, ID Plan</small>
            </div>
            <button type="submit" class="btn btn-primary">Importar Socios</button>
        </form>
    </div>
</div>

<!-- Modal Nuevo Socio -->
<div id="modalNuevoSocio" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Nuevo Socio</h3>
            <button class="modal-close" onclick="closeModal('modalNuevoSocio')">&times;</button>
        </div>
        <form id="formNuevoSocio" onsubmit="crearSocio(event)">
            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" name="nombre" required>
            </div>
            <div class="form-group">
                <label>Apellido *</label>
                <input type="text" name="apellido" required>
            </div>
            <div class="form-group">
                <label>DNI *</label>
                <input type="text" name="dni" required>
            </div>
            <div class="form-group">
                <label>Email *</label>
                <input type="email" name="email" required>
            </div>
            <div class="form-group">
                <label>Plan de Membresía *</label>
                <select name="plan_membresia_id" id="planSelect" required>
                    <option value="">Seleccione un plan...</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Crear Socio</button>
        </form>
    </div>
</div>

<!-- Modal Asignar Plan -->
<div id="modalAsignarPlan" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Asignar Plan de Membresía</h3>
            <button class="modal-close" onclick="closeModal('modalAsignarPlan')">&times;</button>
        </div>
        <form id="formAsignarPlan" onsubmit="asignarPlan(event)">
            <input type="hidden" id="asignarSocioId" name="socio_id">
            <div class="form-group">
                <label>Socio</label>
                <input type="text" id="asignarSocioNombre" disabled>
            </div>
            <div class="form-group">
                <label>Plan de Membresía *</label>
                <select name="plan_membresia_id" id="asignarPlanSelect" required>
                    <option value="">Seleccione un plan...</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="reactivar" id="reactivarCheck" checked>
                    Reactivar membresía (cambiar estado a Activa)
                </label>
            </div>
            <button type="submit" class="btn btn-primary">Asignar Plan</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Cargar planes para el select
    async function cargarPlanes() {
        try {
            const data = await apiRequest('/api/planes');
            const select = document.getElementById('planSelect');
            select.innerHTML = '<option value="">Seleccione un plan...</option>';

            // La API devuelve data.data, no data.planes
            const planes = data.data || [];
            planes.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.titulo} - ${formatCurrency(plan.precio)}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error cargando planes:', error);
        }
    }

    // Cargar lista de socios
    async function cargarSocios() {
        try {
            const data = await apiRequest('/api/socios');
            const container = document.getElementById('socios-list');

            // La API devuelve data.data, no data.socios
            const socios = data.data || [];

            if (socios.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No hay socios registrados</p>';
                return;
            }

            container.innerHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>DNI</th>
                            <th>Email</th>
                            <th>Plan</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${socios.map(socio => `
                            <tr>
                                <td>${socio.id}</td>
                                <td>${socio.nombre_completo}</td>
                                <td>${socio.dni}</td>
                                <td>${socio.email}</td>
                                <td>${socio.plan || 'Sin plan'}</td>
                                <td>
                                    ${socio.estado_membresia === 'activa'
                    ? '<span class="badge badge-success">Activa</span>'
                    : socio.estado_membresia === 'suspendida'
                        ? '<span class="badge badge-warning">Suspendida</span>'
                        : socio.estado_membresia === 'baja_solicitada'
                            ? '<span class="badge badge-warning">Baja Solicitada</span>'
                            : socio.estado_membresia === 'baja_definitiva'
                                ? '<span class="badge badge-danger">Baja Definitiva</span>'
                                : '<span class="badge badge-danger">Inactiva</span>'}
                                </td>
                                <td>
                                    ${!socio.plan ? `<button class="btn btn-sm btn-primary" onclick="abrirAsignarPlan(${socio.id}, '${socio.nombre_completo}')">Asignar Plan</button>` : ''}
                                    <button class="btn btn-sm btn-danger" onclick="eliminarSocio(${socio.id})">Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        } catch (error) {
            const container = document.getElementById('socios-list');
            container.innerHTML = '<div class="alert alert-error">Error al cargar socios</div>';
        }
    }

    // Crear nuevo socio
    async function crearSocio(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        const socio = {
            nombre: formData.get('nombre'),
            apellido: formData.get('apellido'),
            dni: formData.get('dni'),
            email: formData.get('email'),
            plan_membresia_id: parseInt(formData.get('plan_membresia_id'))
        };

        try {
            await apiRequest('/api/socios', {
                method: 'POST',
                body: JSON.stringify(socio)
            });

            showAlert('Socio creado exitosamente', 'success');
            closeModal('modalNuevoSocio');
            form.reset();
            cargarSocios();
        } catch (error) {
            console.error('Error creando socio:', error);
        }
    }

    // Importar CSV
    async function importarCSV(event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        try {
            const response = await fetch('/api/socios/importar-csv', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                const stats = data.data || {};
                const totalImportados = (stats.creados || 0) + (stats.actualizados || 0);
                showAlert(`Importación exitosa: ${totalImportados} socios procesados (${stats.creados || 0} nuevos, ${stats.actualizados || 0} actualizados)`, 'success');
                closeModal('modalImportCSV');
                form.reset();
                cargarSocios();
            } else {
                showAlert(data.message || 'Error al importar CSV', 'error');
            }
        } catch (error) {
            console.error('Error importando CSV:', error);
            showAlert('Error al importar archivo CSV', 'error');
        }
    }

    // Eliminar socio
    async function eliminarSocio(id) {
        if (!confirm('¿Está seguro de eliminar este socio?')) return;

        try {
            await apiRequest(`/api/socios/${id}`, { method: 'DELETE' });
            showAlert('Socio eliminado correctamente', 'success');
            cargarSocios();
        } catch (error) {
            console.error('Error eliminando socio:', error);
        }
    }

    // Abrir modal de asignar plan
    function abrirAsignarPlan(socioId, socioNombre) {
        document.getElementById('asignarSocioId').value = socioId;
        document.getElementById('asignarSocioNombre').value = socioNombre;

        // Cargar planes en el select del modal
        cargarPlanesParaAsignar();

        openModal('modalAsignarPlan');
    }

    // Cargar planes para el modal de asignar
    async function cargarPlanesParaAsignar() {
        try {
            const data = await apiRequest('/api/planes');
            const select = document.getElementById('asignarPlanSelect');
            select.innerHTML = '<option value="">Seleccione un plan...</option>';

            const planes = data.data || [];
            planes.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.titulo} - ${formatCurrency(plan.precio)}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error cargando planes:', error);
        }
    }

    // Asignar plan a socio
    async function asignarPlan(event) {
        event.preventDefault();

        const socioId = document.getElementById('asignarSocioId').value;
        const planId = document.getElementById('asignarPlanSelect').value;
        const reactivar = document.getElementById('reactivarCheck').checked;

        const data = {
            plan_membresia_id: parseInt(planId)
        };

        // Si se marca reactivar, también cambiar el estado
        if (reactivar) {
            data.estado_membresia = 'activa';
        }

        try {
            await apiRequest(`/api/socios/${socioId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            showAlert('Plan asignado exitosamente', 'success');
            closeModal('modalAsignarPlan');
            cargarSocios();
        } catch (error) {
            console.error('Error asignando plan:', error);
        }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        cargarSocios();
        cargarPlanes();
    });
</script>
{% endblock %}