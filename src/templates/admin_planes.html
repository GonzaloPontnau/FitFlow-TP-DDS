{% extends "base.html" %}

{% block title %}Gesti√≥n de Planes - FitFlow Admin{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"
        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <h2 class="card-title">Gesti√≥n de Planes de Membres√≠a</h2>
        <button class="btn btn-primary" onclick="mostrarFormulario()">+ Nuevo Plan</button>
    </div>

    <!-- Formulario de Plan (oculto por defecto) -->
    <div id="plan-form-container" style="display: none;">
        <div class="form-card">
            <h3 id="form-title">Nuevo Plan</h3>
            <form id="plan-form" onsubmit="guardarPlan(event)">
                <input type="hidden" id="plan-id">

                <div class="form-group">
                    <label for="titulo">Nombre del Plan *</label>
                    <input type="text" id="titulo" name="titulo" required placeholder="Ej: Plan Premium"
                        class="form-control">
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripci√≥n *</label>
                    <textarea id="descripcion" name="descripcion" required rows="3"
                        placeholder="Ej: Acceso completo a todas las clases..." class="form-control"></textarea>
                </div>

                <div class="form-group">
                    <label for="precio">Precio Mensual ($) *</label>
                    <input type="number" id="precio" name="precio" required min="1" step="any" placeholder="Ej: 32000"
                        class="form-control">
                </div>

                <div class="form-group">
                    <label for="nivel">Nivel del Plan *</label>
                    <input type="number" id="nivel" name="nivel" required min="1" value="1" placeholder="Ej: 1, 2, 3..."
                        class="form-control">
                    <small style="color: var(--text-muted);">Niveles m√°s altos acceden a clases de niveles
                        inferiores</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="ocultarFormulario()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Planes -->
    <div id="planes-list">
        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando planes...</p>
        </div>
    </div>
</div>

<style>
    .form-card {
        background: var(--card-bg);
        border: 2px solid var(--primary-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-card h3 {
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-dark);
        color: var(--text-color);
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .plan-item {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .plan-info h4 {
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .plan-info .price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--secondary-color);
    }

    .plan-info .description {
        color: var(--text-muted);
        margin-top: 0.5rem;
    }

    .plan-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-edit {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }

    .btn-delete {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .badge-inactive {
        background: #6c757d;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-left: 0.5rem;
    }

    .plan-clases {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Cargar lista de planes
    async function cargarPlanes() {
        try {
            const data = await apiRequest('/api/planes');
            const container = document.getElementById('planes-list');
            const planes = data.data || [];

            if (planes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 3rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">No hay planes registrados</p>
                        <button class="btn btn-primary" onclick="mostrarFormulario()">Crear Primer Plan</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = planes.map(plan => `
                <div class="plan-item">
                    <div class="plan-info">
                        <h4>
                            ${plan.titulo}
                            ${!plan.activo ? '<span class="badge-inactive">Inactivo</span>' : ''}
                        </h4>
                        <div class="price">${formatCurrency(plan.precio)}</div>
                        <p class="description">${plan.descripcion || 'Sin descripci√≥n'}</p>
                        <p class="plan-clases">
                            <strong>Clases incluidas:</strong> ${plan.cantidad_clases || 0}
                        </p>
                    </div>
                    <div class="plan-actions">
                        <button class="btn btn-edit" onclick="editarPlan(${plan.id})">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn btn-delete" onclick="eliminarPlan(${plan.id}, '${plan.titulo}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            document.getElementById('planes-list').innerHTML =
                '<div class="alert alert-error">Error al cargar planes</div>';
        }
    }

    // Mostrar formulario
    function mostrarFormulario(plan = null) {
        document.getElementById('plan-form-container').style.display = 'block';
        document.getElementById('form-title').textContent = plan ? 'Editar Plan' : 'Nuevo Plan';

        if (plan) {
            document.getElementById('plan-id').value = plan.id;
            document.getElementById('titulo').value = plan.titulo;
            document.getElementById('descripcion').value = plan.descripcion || '';
            document.getElementById('precio').value = plan.precio;
            document.getElementById('nivel').value = plan.nivel || 1;
        } else {
            document.getElementById('plan-form').reset();
            document.getElementById('plan-id').value = '';
        }

        // Scroll al formulario
        document.getElementById('plan-form-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Ocultar formulario
    function ocultarFormulario() {
        document.getElementById('plan-form-container').style.display = 'none';
        document.getElementById('plan-form').reset();
    }

    // Guardar plan (crear o actualizar)
    async function guardarPlan(event) {
        event.preventDefault();

        const planId = document.getElementById('plan-id').value;
        const data = {
            titulo: document.getElementById('titulo').value,
            descripcion: document.getElementById('descripcion').value,
            precio: parseFloat(document.getElementById('precio').value),
            nivel: parseInt(document.getElementById('nivel').value)
        };

        try {
            if (planId) {
                // Actualizar
                await apiRequest(`/api/planes/${planId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showAlert('Plan actualizado correctamente', 'success');
            } else {
                // Crear
                await apiRequest('/api/planes', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showAlert('Plan creado correctamente', 'success');
            }

            ocultarFormulario();
            cargarPlanes();
        } catch (error) {
            showAlert('Error al guardar el plan: ' + error.message, 'error');
        }
    }

    // Editar plan
    async function editarPlan(planId) {
        try {
            const data = await apiRequest(`/api/planes/${planId}`);
            mostrarFormulario(data.data);
        } catch (error) {
            showAlert('Error al cargar el plan', 'error');
        }
    }

    // Eliminar plan
    async function eliminarPlan(planId, titulo) {
        if (!confirm(`¬øEst√°s seguro de eliminar el plan "${titulo}"?\n\nEsto desactivar√° el plan pero no eliminar√° los datos.`)) {
            return;
        }

        try {
            await apiRequest(`/api/planes/${planId}`, { method: 'DELETE' });
            showAlert('Plan eliminado correctamente', 'success');
            cargarPlanes();
        } catch (error) {
            showAlert('Error al eliminar el plan: ' + error.message, 'error');
        }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        cargarPlanes();
    });
</script>
{% endblock %}