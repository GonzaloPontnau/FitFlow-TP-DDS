{% extends "base.html" %}

{% block title %}Solicitar Baja - FitFlow{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 2rem auto;">
    <div class="card-header text-center">
        <h2 class="card-title">Solicitud de Cancelación de Membresía</h2>
        <p class="text-muted" style="margin-top: 0.5rem;">
            Lamentamos que te vayas. Completa este formulario para procesar tu solicitud.
        </p>
    </div>

    <form id="baja-form" onsubmit="enviarSolicitud(event)" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label for="dni">Número de DNI *</label>
            <input type="text" id="dni" name="dni" required placeholder="Ingresa tu DNI sin puntos" class="form-control"
                pattern="\d{7,8}" title="El DNI debe tener 7 u 8 dígitos">
        </div>

        <div class="form-group">
            <label for="email">Correo Electrónico *</label>
            <input type="email" id="email" name="email" required placeholder="tucorreo@ejemplo.com"
                class="form-control">
            <small class="text-muted">Debe coincidir con el correo registrado en tu cuenta.</small>
        </div>

        <div class="form-group">
            <label for="justificacion">Motivo de la Baja *</label>
            <textarea id="justificacion" name="justificacion" required rows="4"
                placeholder="Por favor, cuéntanos brevemente por qué deseas cancelar tu suscripción (mínimo 20 caracteres)..."
                class="form-control" minlength="20"></textarea>
        </div>

        <!-- Alert messages -->
        <div id="alert-container" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px;"></div>

        <div class="form-actions" style="margin-top: 2rem;">
            <button type="submit" id="btn-submit" class="btn btn-primary" style="width: 100%;">
                Enviar Solicitud
            </button>
            <a href="/" class="btn btn-secondary"
                style="width: 100%; text-align: center; margin-top: 0.5rem; display: block; text-decoration: none;">
                Cancelar y Volver al Inicio
            </a>
        </div>
    </form>
</div>

<style>
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .form-control {
        width: 100%;
        padding: 0.875rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-dark);
        color: var(--text-color);
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }

    .text-muted {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .text-center {
        text-align: center;
    }

    .alert-success {
        background-color: rgba(40, 167, 69, 0.1);
        border: 1px solid #28a745;
        color: #28a745;
    }

    .alert-error {
        background-color: rgba(220, 53, 69, 0.1);
        border: 1px solid #dc3545;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    async function enviarSolicitud(event) {
        event.preventDefault();

        const btn = document.getElementById('btn-submit');
        const alertContainer = document.getElementById('alert-container');
        const form = document.getElementById('baja-form');

        // Reset UI
        btn.disabled = true;
        btn.textContent = 'Enviando...';
        alertContainer.style.display = 'none';

        const data = {
            dni: document.getElementById('dni').value,
            email: document.getElementById('email').value,
            justificacion: document.getElementById('justificacion').value
        };

        try {
            const response = await fetch('/api/solicitudes/publica', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                // Success
                form.reset();
                alertContainer.className = 'alert-success';
                alertContainer.textContent = 'Solicitud enviada correctamente. Un administrador revisará tu caso pronto.';
                alertContainer.style.display = 'block';

                // Redirigir después de 3 segundos
                setTimeout(() => {
                    window.location.href = '/';
                }, 4000);
            } else {
                // Error from API
                throw new Error(result.message || 'Error al procesar la solicitud');
            }
        } catch (error) {
            alertContainer.className = 'alert-error';
            alertContainer.textContent = '❌ ' + error.message;
            alertContainer.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = 'Enviar Solicitud';
        }
    }
</script>
{% endblock %}