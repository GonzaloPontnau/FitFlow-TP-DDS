{% extends "base.html" %}

{% block title %}Calendario - FitFlow{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Calendario de Clases</h2>
        <div>
            <label style="display: inline-block; margin-right: 1rem;">
                <input type="checkbox" id="incluirExternas" onchange="cargarCalendario()" checked>
                Incluir clases externas
            </label>
        </div>
    </div>

    <div id="calendario-content">
        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando calendario...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Cargar calendario
    async function cargarCalendario() {
        try {
            const incluirExternas = document.getElementById('incluirExternas').checked;
            // Usar modo=ocupado para ver todas las clases, modo=normal para solo con cupo
            const modo = 'ocupado';
            const response = await apiRequest(`/api/calendario?modo=${modo}`);
            const container = document.getElementById('calendario-content');

            let eventos = response.data || [];
            
            // Filtrar clases externas si el checkbox no esta marcado
            if (!incluirExternas) {
                eventos = eventos.filter(e => e.tipo !== 'externa');
            }

            if (eventos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">No hay clases en el calendario</p>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Las clases se muestran aqui una vez que el administrador las crea desde la seccion 
                            <a href="/clases" style="color: var(--primary-color);">Clases</a>.
                        </p>
                    </div>
                `;
                return;
            }

            // Agrupar por fecha
            const eventosPorFecha = {};

            eventos.forEach(evento => {
                const fecha = evento.fecha || 'Sin fecha';
                if (!eventosPorFecha[fecha]) {
                    eventosPorFecha[fecha] = [];
                }
                eventosPorFecha[fecha].push(evento);
            });

            // Ordenar fechas
            const fechasOrdenadas = Object.keys(eventosPorFecha).sort();

            // Ordenar eventos por hora dentro de cada fecha
            fechasOrdenadas.forEach(fecha => {
                eventosPorFecha[fecha].sort((a, b) => {
                    const horaA = a.hora_inicio || '';
                    const horaB = b.hora_inicio || '';
                    return horaA.localeCompare(horaB);
                });
            });

            // Formatear fecha para mostrar
            function formatearFecha(fechaStr) {
                const fecha = new Date(fechaStr + 'T00:00:00');
                const opciones = { weekday: 'long', day: 'numeric', month: 'long' };
                return fecha.toLocaleDateString('es-AR', opciones);
            }

            container.innerHTML = fechasOrdenadas.map(fecha => {
                const eventosDelDia = eventosPorFecha[fecha];

                return `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); text-transform: capitalize;">
                        ${formatearFecha(fecha)}
                    </h3>
                    <div class="grid">
                        ${eventosDelDia.map(evento => {
                    const esExterna = evento.tipo === 'externa';

                    return `
                                <div class="grid-item" style="${esExterna ? 'border-left: 4px solid var(--warning-color);' : ''}">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <h4 style="color: var(--primary-color); margin: 0;">
                                            ${evento.titulo || evento.nombre || 'Sin título'}
                                        </h4>
                                        ${esExterna
                            ? '<span class="badge badge-warning">Externa</span>'
                            : '<span class="badge badge-info">Propia</span>'
                        }
                                    </div>
                                    
                                    <p style="color: var(--text-muted); margin-bottom: 1rem;">
                                        ${evento.descripcion || 'Sin descripción'}
                                    </p>
                                    
                                    <div style="font-size: 0.875rem;">
                                        <div style="margin-bottom: 0.5rem;">
                                            <strong>Horario:</strong> ${evento.hora_inicio || 'N/A'}
                                            ${evento.duracion_minutos ? `(${evento.duracion_minutos} min)` : ''}
                                        </div>
                                        ${evento.instructor
                            ? `<div style="margin-bottom: 0.5rem;">
                                                <strong>Instructor:</strong> ${evento.instructor}
                                               </div>`
                            : ''
                        }
                                        ${evento.cupo_maximo
                            ? `<div style="margin-bottom: 0.5rem;">
                                                <strong>Cupo:</strong> 
                                                ${evento.cupos_disponibles || 0} disponibles / ${evento.cupo_maximo}
                                               </div>`
                            : ''
                        }
                                        ${esExterna && evento.ubicacion
                            ? `<div style="margin-bottom: 0.5rem;">
                                                <strong>Ubicación:</strong> ${evento.ubicacion}
                                               </div>`
                            : ''
                        }
                                        ${esExterna
                            ? `<button class="btn btn-sm btn-secondary" style="margin-top: 0.5rem;" onclick="alert('Las clases externas son de proveedores externos. Esta es una simulacion para el TP.')">
                                                Info Inscripcion
                                               </button>`
                            : ''
                        }
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                </div>
            `;
            }).join('');

            // Mostrar información de resumen
            const totalEventos = eventos.length;
            const eventosExternos = eventos.filter(e => e.tipo === 'externa').length;
            const eventosPropios = totalEventos - eventosExternos;

            const resumen = `
            <div class="alert alert-info" style="margin-bottom: 2rem;">
                <strong>Resumen:</strong> 
                ${totalEventos} clases totales 
                (${eventosPropios} propias, ${eventosExternos} externas)
            </div>
        `;

            container.innerHTML = resumen + container.innerHTML;

        } catch (error) {
            console.error('Error cargando calendario:', error);
            const container = document.getElementById('calendario-content');
            container.innerHTML = '<div class="alert alert-error">Error al cargar calendario</div>';
        }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        cargarCalendario();
    });
</script>
{% endblock %}