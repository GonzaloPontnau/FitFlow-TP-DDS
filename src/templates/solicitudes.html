{% extends "base.html" %}

{% block title %}Solicitudes de Baja - FitFlow{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Solicitudes de Baja de Membresía</h2>
        <button class="btn btn-primary" onclick="openModal('modalNuevaSolicitud')">+ Nueva Solicitud</button>
    </div>

    <!-- Filtros -->
    <div class="filters">
        <select id="filtroEstado" onchange="cargarSolicitudes()">
            <option value="">Todas las solicitudes</option>
            <option value="pendiente">Pendientes</option>
            <option value="aprobada">Aprobadas</option>
            <option value="rechazada">Rechazadas</option>
        </select>
    </div>

    <div id="solicitudes-list">
        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando solicitudes...</p>
        </div>
    </div>
</div>

<!-- Modal Nueva Solicitud -->
<div id="modalNuevaSolicitud" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Nueva Solicitud de Baja</h3>
            <button class="modal-close" onclick="closeModal('modalNuevaSolicitud')">&times;</button>
        </div>
        <form onsubmit="crearSolicitud(event)">
            <div class="form-group">
                <label for="socio_id">Socio</label>
                <select id="socio_id" name="socio_id" required>
                    <option value="">Seleccionar socio...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="justificacion">Justificación (mínimo 150 caracteres)</label>
                <textarea id="justificacion" name="justificacion" rows="5" required minlength="150"
                    placeholder="Explique el motivo de la solicitud de baja..."></textarea>
                <small id="charCount">0/150 caracteres</small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('modalNuevaSolicitud')">Cancelar</button>
                <button type="submit" class="btn btn-primary">Enviar Solicitud</button>
            </div>
        </form>
    </div>
</div>

<style>
    .filters {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--bg-dark);
        border-radius: 8px;
    }

    .filters select {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-color);
    }

    .solicitud-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .solicitud-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .solicitud-socio {
        font-weight: bold;
        font-size: 1.1rem;
    }

    .solicitud-fecha {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .solicitud-justificacion {
        background: var(--bg-dark);
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        font-style: italic;
    }

    .solicitud-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .badge-pendiente {
        background: #ffc107;
        color: #212529;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
    }

    .badge-aprobada {
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
    }

    .badge-rechazada {
        background: #dc3545;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    async function cargarSolicitudes() {
        const estado = document.getElementById('filtroEstado').value;
        const url = estado ? `/api/solicitudes?estado=${estado}` : '/api/solicitudes';

        try {
            const data = await apiRequest(url);
            const container = document.getElementById('solicitudes-list');
            const solicitudes = data.data || [];

            if (solicitudes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No hay solicitudes de baja</p>';
                return;
            }

            container.innerHTML = solicitudes.map(sol => `
            <div class="solicitud-card">
                <div class="solicitud-header">
                    <span class="solicitud-socio">${sol.socio_nombre || 'Socio #' + sol.socio_id}</span>
                    <span class="badge-${sol.estado}">${sol.estado.charAt(0).toUpperCase() + sol.estado.slice(1)}</span>
                </div>
                <div class="solicitud-fecha">Solicitado: ${new Date(sol.fecha_solicitud).toLocaleDateString('es-AR')}</div>
                <div class="solicitud-justificacion">
                    "${sol.justificacion}"
                </div>
                ${sol.estado === 'pendiente' ? `
                    <div class="solicitud-actions">
                        <button class="btn btn-success" onclick="aprobarSolicitud(${sol.id})">Aprobar</button>
                        <button class="btn btn-danger" onclick="rechazarSolicitud(${sol.id})">Rechazar</button>
                    </div>
                ` : ''}
            </div>
        `).join('');
        } catch (error) {
            console.error('Error cargando solicitudes:', error);
            document.getElementById('solicitudes-list').innerHTML =
                '<div class="alert alert-error">Error al cargar solicitudes</div>';
        }
    }

    async function aprobarSolicitud(id) {
        if (!confirm('¿Está seguro de aprobar esta solicitud de baja?')) return;

        try {
            await apiRequest(`/api/solicitudes/${id}/aprobar`, { method: 'PUT' });
            showAlert('Solicitud aprobada correctamente', 'success');
            cargarSolicitudes();
        } catch (error) {
            console.error('Error aprobando solicitud:', error);
        }
    }

    async function rechazarSolicitud(id) {
        const motivo = prompt('Ingrese el motivo del rechazo:');
        if (!motivo) return;

        try {
            await apiRequest(`/api/solicitudes/${id}/rechazar`, {
                method: 'PUT',
                body: JSON.stringify({ comentario_admin: motivo })
            });
            showAlert('Solicitud rechazada', 'info');
            cargarSolicitudes();
        } catch (error) {
            console.error('Error rechazando solicitud:', error);
        }
    }

    // Cargar socios para el dropdown
    async function cargarSocios() {
        try {
            const data = await apiRequest('/api/socios');
            const select = document.getElementById('socio_id');
            const socios = data.data || [];

            socios.forEach(socio => {
                const option = document.createElement('option');
                option.value = socio.id;
                option.textContent = `${socio.nombre_completo} (DNI: ${socio.dni})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error cargando socios:', error);
        }
    }

    // Crear nueva solicitud de baja
    async function crearSolicitud(event) {
        event.preventDefault();

        const socioId = document.getElementById('socio_id').value;
        const justificacion = document.getElementById('justificacion').value;

        if (justificacion.length < 150) {
            showAlert('La justificación debe tener al menos 150 caracteres', 'error');
            return;
        }

        try {
            await apiRequest('/api/solicitudes', {
                method: 'POST',
                body: JSON.stringify({
                    socio_id: parseInt(socioId),
                    justificacion: justificacion
                })
            });

            showAlert('Solicitud creada exitosamente', 'success');
            closeModal('modalNuevaSolicitud');
            document.getElementById('socio_id').value = '';
            document.getElementById('justificacion').value = '';
            document.getElementById('charCount').textContent = '0/150 caracteres';
            cargarSolicitudes();
        } catch (error) {
            console.error('Error creando solicitud:', error);
        }
    }

    // Contador de caracteres
    document.addEventListener('DOMContentLoaded', () => {
        cargarSolicitudes();
        cargarSocios();

        const textarea = document.getElementById('justificacion');
        const charCount = document.getElementById('charCount');

        textarea.addEventListener('input', () => {
            const length = textarea.value.length;
            charCount.textContent = `${length}/150 caracteres`;
            charCount.style.color = length >= 150 ? 'var(--secondary-color)' : 'var(--text-muted)';
        });
    });
</script>
{% endblock %}